<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Spy</title>
    <style>
        body { background-color: #0d0d0d; color: #00ff99; font-family: 'Courier New', monospace; text-align: center; padding: 10px; }
        .container { max-width: 500px; margin: 0 auto; background: #1a1a1a; padding: 15px; border-radius: 10px; border: 1px solid #333; }
        input { width: 90%; padding: 12px; margin: 5px 0; background: #222; border: 1px solid #444; color: white; }
        button { width: 100%; padding: 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; }
        
        .btn-create { background: #00ff99; color: black; }
        .btn-scare { background: #ff0055; color: white; height: 100px; font-size: 28px; display: none; margin-top: 20px; box-shadow: 0 0 20px rgba(255, 0, 85, 0.4); animation: pulse 1s infinite; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        
        #live-users-panel { display: none; margin-top: 20px; text-align: left; background: #111; padding: 10px; border: 1px solid #333; }
        .user-row { background: #222; padding: 10px; margin-bottom: 5px; border-left: 3px solid #00ff99; display: flex; justify-content: space-between; align-items: center; font-size: 13px;}
        .user-online { color: #00ff99; font-weight: bold; }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
        
        #history-panel { margin-top: 30px; text-align: left; }
        .history-item { background: #222; padding: 10px; margin-bottom: 8px; border-radius: 5px; font-size: 12px; cursor: pointer; border-left: 3px solid #555; }
        .active-room { border-left: 3px solid #ff0055; background: #2a1a1a; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üëÅÔ∏è SPY CONTROL</h1>
        
        <div id="setup-step">
            <input type="text" id="imgUrl" placeholder="–ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL)">
            <input type="text" id="sndUrl" placeholder="–ó–≤—É–∫ (URL .mp3)" value="https://www.myinstants.com/media/sounds/scream.mp3">
            <button class="btn-create" onclick="createLink()">–°–¢–í–û–†–ò–¢–ò –ü–ê–°–¢–ö–£</button>
        </div>

        <div id="control-panel" style="display: none;">
            <div style="background: #333; padding: 10px; font-size: 12px; word-break: break-all;">
                <a id="victim-link" href="admin.html#" target="_blank" style="color: #4db8ff;">...</a>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #222; border-radius: 8px;">
                <h3 style="margin: 0 0 10px 0; font-size: 14px; color: #00ff99;">–ó–ú–Ü–ù–ò–¢–ò –ü–ê–°–¢–ö–£</h3>
                <input type="text" id="newImgUrl" placeholder="–ù–æ–≤–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞ (URL)" style="width: 100%; margin-bottom: 8px;">
                <input type="text" id="newSndUrl" placeholder="–ù–æ–≤–∏–π –∑–≤—É–∫ (URL .mp3)" style="width: 100%; margin-bottom: 8px;">
                <button onclick="updateMedia()" style="width: 100%; padding: 12px; background: #00ccff; color: black; font-weight: bold;">
                    –û–ù–û–í–ò–¢–ò –î–õ–Ø –í–°–Ü–•
                </button>
            </div>

            <div id="live-users-panel">
                <div style="font-size: 10px; color: #777; margin-bottom: 5px;">LIVE CONNECTIONS:</div>
                <div id="users-list">Checking...</div>
            </div>

            <button id="scare-btn" class="btn-scare" onclick="trigger()">–ù–ê–õ–Ø–ö–ê–¢–ò üíÄ</button>
            <button onclick="location.reload()" style="background: #333; color: #888; margin-top: 20px; padding: 10px;">‚¨Ö –ú–µ–Ω—é</button>
        </div>

        <div id="history-panel">
            <h3 style="color: #666; font-size: 14px;">–Ü–°–¢–û–†–Ü–Ø</h3>
            <div id="history-list"></div>
        </div>
    </div>

    <script src="socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentSessionId = null;

        window.onload = loadHistory;

        async function createLink() {
            const image = document.getElementById('imgUrl').value.trim();
            const sound = document.getElementById('sndUrl').value.trim();
            
            const res = await fetch('/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ image, sound })
            });
            const data = await res.json();
            
            saveToHistory(data.id, data.createdAt);
            activateRoom(data.id);
            loadHistory();
        }

        async function updateMedia() {
            if (!currentSessionId) return;

            const newImage = document.getElementById('newImgUrl').value.trim();
            const newSound = document.getElementById('newSndUrl').value.trim();

            if (!newImage && !newSound) {
                alert('–í–≤–µ–¥—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–Ω–µ –Ω–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è');
                return;
            }

            const body = {};
            if (newImage) body.image = newImage;
            if (newSound) body.sound = newSound;

            const res = await fetch(`/update-session/${currentSessionId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            const result = await res.json();

            if (res.ok) {
                alert('–ü–∞—Å—Ç–∫—É —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è –≤—Å—ñ—Ö –∂–µ—Ä—Ç–≤!');
                document.getElementById('newImgUrl').value = '';
                document.getElementById('newSndUrl').value = '';
            } else {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + (result.error || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'));
            }
        }

        function activateRoom(id) {
            currentSessionId = id;
            document.getElementById('setup-step').style.display = 'none';
            document.getElementById('history-panel').style.display = 'none';
            document.getElementById('control-panel').style.display = 'block';
            
            const link = `${window.location.origin}/victim.html?id=${id}`;
            document.getElementById('victim-link').href = link;
            document.getElementById('victim-link').innerText = link;
            
            socket.emit('join-room-admin', id);
        }

        function trigger() {
            if(currentSessionId) socket.emit('trigger-scare', currentSessionId);
        }

        socket.on('update-victim-list', (users) => {
            const listDiv = document.getElementById('users-list');
            const panel = document.getElementById('live-users-panel');
            const scareBtn = document.getElementById('scare-btn');
            
            panel.style.display = 'block';
            if (users.length === 0) {
                listDiv.innerHTML = '<div style="color: #555; font-style: italic;">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∂–µ—Ä—Ç–≤–∏...</div>';
                scareBtn.style.display = 'none';
            } else {
                scareBtn.style.display = 'block';
                listDiv.innerHTML = '';
                
                users.forEach(u => {
                    const row = document.createElement('div');
                    row.className = 'user-row';
                    const shortIp = u.ip.split(',')[0];
                    
                    row.innerHTML = `
                        <div>
                            <span style="font-size:14px;">${u.device}</span><br>
                            <span style="color:#666; font-size:10px;">IP: ${shortIp}</span>
                        </div>
                        <div class="user-online">‚óè ONLINE</div>
                    `;
                    listDiv.appendChild(row);
                });
            }
        });

        socket.on('admin-alert', () => {
            if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
        });

        function getSavedIds() { return JSON.parse(localStorage.getItem('prank_rooms') || '[]'); }
        function saveToHistory(id, date) {
            const list = getSavedIds();
            list.unshift({ id, date });
            if(list.length > 15) list.pop();
            localStorage.setItem('prank_rooms', JSON.stringify(list));
        }

        async function loadHistory() {
            const list = getSavedIds();
            if(list.length === 0) return;
            const idsOnly = list.map(i => i.id);
            const res = await fetch('/check-status', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ids: idsOnly })
            });
            const statuses = await res.json();
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            statuses.forEach(room => {
                const isActive = room.count > 0;
                const div = document.createElement('div');
                div.className = `history-item ${isActive ? 'active-room' : ''}`;
                div.onclick = () => activateRoom(room.id);
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <span>ROOM ...${room.id.slice(0, 4)}</span>
                        ${isActive ? `<span class="blink" style="color:#ff0055;">üëÅÔ∏è ${room.count} ONLINE</span>` : '<span style="color:#555;">Offline</span>'}
                    </div>
                `;
                container.appendChild(div);
            });
        }
    </script>
</body>
</html>
